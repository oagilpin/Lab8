<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Olivia Gilpin">
<meta name="dcterms.date" content="2025-04-16">

<title>CSU_ESS330_Lab8</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="floating">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-importtidytransform" id="toc-data-importtidytransform" class="nav-link active" data-scroll-target="#data-importtidytransform">Data Import/Tidy/Transform</a>
  <ul>
  <li><a href="#read-in-the-data" id="toc-read-in-the-data" class="nav-link" data-scroll-target="#read-in-the-data">Read in the data</a></li>
  <li><a href="#clean-the-data" id="toc-clean-the-data" class="nav-link" data-scroll-target="#clean-the-data">Clean the data</a></li>
  </ul></li>
  <li><a href="#data-spliting" id="toc-data-spliting" class="nav-link" data-scroll-target="#data-spliting">Data Spliting</a>
  <ul>
  <li><a href="#set-a-seed" id="toc-set-a-seed" class="nav-link" data-scroll-target="#set-a-seed">Set a seed</a></li>
  <li><a href="#use-the-initial_split-function-from-the-rsample-package-to-split-the-data.-use-80-of-the-data-for-training-and-20-for-testing." id="toc-use-the-initial_split-function-from-the-rsample-package-to-split-the-data.-use-80-of-the-data-for-training-and-20-for-testing." class="nav-link" data-scroll-target="#use-the-initial_split-function-from-the-rsample-package-to-split-the-data.-use-80-of-the-data-for-training-and-20-for-testing.">Use the initial_split() function from the rsample package to split the data. Use 80% of the data for training and 20% for testing.</a></li>
  <li><a href="#use-the-training-and-testing-functions-from-the-rsample-package-to-extract-the-training-and-testing-data.frames." id="toc-use-the-training-and-testing-functions-from-the-rsample-package-to-extract-the-training-and-testing-data.frames." class="nav-link" data-scroll-target="#use-the-training-and-testing-functions-from-the-rsample-package-to-extract-the-training-and-testing-data.frames.">Use the training() and testing() functions from the rsample package to extract the training and testing data.frames.</a></li>
  </ul></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature Engineering</a>
  <ul>
  <li><a href="#use-the-recipe-function-from-the-recipes-package-to-create-a-recipe-object." id="toc-use-the-recipe-function-from-the-recipes-package-to-create-a-recipe-object." class="nav-link" data-scroll-target="#use-the-recipe-function-from-the-recipes-package-to-create-a-recipe-object.">Use the recipe() function from the recipes package to create a recipe object.</a>
  <ul class="collapse">
  <li><a href="#you-should-not-use-gauge_lat-and-gauge_lon-in-the-recipe-as-predictors.-you-can-use-the-step_rm-function-to-remove-them-from-the-recipe-while-ensureing-they-persist-in-any-data-passed-throuhg-fit_.-done" id="toc-you-should-not-use-gauge_lat-and-gauge_lon-in-the-recipe-as-predictors.-you-can-use-the-step_rm-function-to-remove-them-from-the-recipe-while-ensureing-they-persist-in-any-data-passed-throuhg-fit_.-done" class="nav-link" data-scroll-target="#you-should-not-use-gauge_lat-and-gauge_lon-in-the-recipe-as-predictors.-you-can-use-the-step_rm-function-to-remove-them-from-the-recipe-while-ensureing-they-persist-in-any-data-passed-throuhg-fit_.-done">You should not use gauge_lat and gauge_lon in the recipe as predictors. You can use the step_rm() function to remove them from the recipe while ensureing they persist in any data passed throuhg fit_*. – DONE</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#resampling-and-model-testing" id="toc-resampling-and-model-testing" class="nav-link" data-scroll-target="#resampling-and-model-testing">Resampling and Model Testing</a>
  <ul>
  <li><a href="#build-resamples" id="toc-build-resamples" class="nav-link" data-scroll-target="#build-resamples">1. Build resamples</a></li>
  <li><a href="#build-3-candidate-models" id="toc-build-3-candidate-models" class="nav-link" data-scroll-target="#build-3-candidate-models">2. Build 3 Candidate Models</a>
  <ul class="collapse">
  <li><a href="#define-3-models-that-you-feel-have-the-best-chance-of-performing-well-on-the-data.-you-can-use-any-of-the-models-we-have-learned-about-in-class.-linear-regression-is-a-baseline-model-that-can-be-effective-if-there-is-a-linear-relationship-between-the-predictors-and-the-outcome-variable.-it-is-fast-to-compute-and-interpretable.-random-forests-are-ensemble-models-that-can-handle-complex-non-linear-relationships-and-interactions-between-predictors.-it-also-handles-missing-data-well-and-is-relatively-robust-to-overfitting.-boosted-trees-like-xgboost-can-perform-well-on-structuredtabular-data-and-often-provide-strong-predictive-performance.-they-work-by-combining-multiple-weak-learners-decision-trees-to-create-a-strong-model-typically-outperforming-random-forests-in-terms-of-accuracy." id="toc-define-3-models-that-you-feel-have-the-best-chance-of-performing-well-on-the-data.-you-can-use-any-of-the-models-we-have-learned-about-in-class.-linear-regression-is-a-baseline-model-that-can-be-effective-if-there-is-a-linear-relationship-between-the-predictors-and-the-outcome-variable.-it-is-fast-to-compute-and-interpretable.-random-forests-are-ensemble-models-that-can-handle-complex-non-linear-relationships-and-interactions-between-predictors.-it-also-handles-missing-data-well-and-is-relatively-robust-to-overfitting.-boosted-trees-like-xgboost-can-perform-well-on-structuredtabular-data-and-often-provide-strong-predictive-performance.-they-work-by-combining-multiple-weak-learners-decision-trees-to-create-a-strong-model-typically-outperforming-random-forests-in-terms-of-accuracy." class="nav-link" data-scroll-target="#define-3-models-that-you-feel-have-the-best-chance-of-performing-well-on-the-data.-you-can-use-any-of-the-models-we-have-learned-about-in-class.-linear-regression-is-a-baseline-model-that-can-be-effective-if-there-is-a-linear-relationship-between-the-predictors-and-the-outcome-variable.-it-is-fast-to-compute-and-interpretable.-random-forests-are-ensemble-models-that-can-handle-complex-non-linear-relationships-and-interactions-between-predictors.-it-also-handles-missing-data-well-and-is-relatively-robust-to-overfitting.-boosted-trees-like-xgboost-can-perform-well-on-structuredtabular-data-and-often-provide-strong-predictive-performance.-they-work-by-combining-multiple-weak-learners-decision-trees-to-create-a-strong-model-typically-outperforming-random-forests-in-terms-of-accuracy.">Define 3 models that you feel have the best chance of performing well on the data. You can use any of the models we have learned about in class. – Linear regression is a baseline model that can be effective if there is a linear relationship between the predictors and the outcome variable. It is fast to compute and interpretable. Random forests are ensemble models that can handle complex, non-linear relationships and interactions between predictors. It also handles missing data well and is relatively robust to overfitting. Boosted trees (like XGBoost) can perform well on structured/tabular data and often provide strong predictive performance. They work by combining multiple weak learners (decision trees) to create a strong model, typically outperforming random forests in terms of accuracy.</a></li>
  </ul></li>
  <li><a href="#test-the-models" id="toc-test-the-models" class="nav-link" data-scroll-target="#test-the-models">3. Test the models</a>
  <ul class="collapse">
  <li><a href="#use-the-workflow_set-function-to-test-your-three-models-against-the-recipe.-you-will-use-the-workflow_map-function-to-map-the-models-to-the-recipe-and-resamples." id="toc-use-the-workflow_set-function-to-test-your-three-models-against-the-recipe.-you-will-use-the-workflow_map-function-to-map-the-models-to-the-recipe-and-resamples." class="nav-link" data-scroll-target="#use-the-workflow_set-function-to-test-your-three-models-against-the-recipe.-you-will-use-the-workflow_map-function-to-map-the-models-to-the-recipe-and-resamples.">Use the workflow_set() function to test your three models against the recipe. You will use the workflow_map() function to map the models to the recipe and resamples.</a></li>
  <li><a href="#once-complete-use-autoplot-to-visualize-the-results-of-the-workflow-set." id="toc-once-complete-use-autoplot-to-visualize-the-results-of-the-workflow-set." class="nav-link" data-scroll-target="#once-complete-use-autoplot-to-visualize-the-results-of-the-workflow-set.">Once complete, use autoplot to visualize the results of the workflow set.</a></li>
  </ul></li>
  <li><a href="#model-selection" id="toc-model-selection" class="nav-link" data-scroll-target="#model-selection">4. Model Selection</a>
  <ul class="collapse">
  <li><a href="#based-on-the-visualized-metrics-select-a-model-that-you-think-best-performs.-describe-the-reason-for-your-choice-using-the-metrics.-based-on-the-visualization-of-model-performance-metrics-i-would-select-the-random-forest-model-as-it-demonstrates-the-lowest-rmse-and-mae-values-while-achieving-the-highest-r-squared-score.-the-random-forests-performance-being-significantly-better-likely-stems-from-its-ability-to-capture-the-non-linear-relationships-in-hydrological-data-and-effectively-model-the-complex-interactions-between-soil-climate-and-water-flow-variables." id="toc-based-on-the-visualized-metrics-select-a-model-that-you-think-best-performs.-describe-the-reason-for-your-choice-using-the-metrics.-based-on-the-visualization-of-model-performance-metrics-i-would-select-the-random-forest-model-as-it-demonstrates-the-lowest-rmse-and-mae-values-while-achieving-the-highest-r-squared-score.-the-random-forests-performance-being-significantly-better-likely-stems-from-its-ability-to-capture-the-non-linear-relationships-in-hydrological-data-and-effectively-model-the-complex-interactions-between-soil-climate-and-water-flow-variables." class="nav-link" data-scroll-target="#based-on-the-visualized-metrics-select-a-model-that-you-think-best-performs.-describe-the-reason-for-your-choice-using-the-metrics.-based-on-the-visualization-of-model-performance-metrics-i-would-select-the-random-forest-model-as-it-demonstrates-the-lowest-rmse-and-mae-values-while-achieving-the-highest-r-squared-score.-the-random-forests-performance-being-significantly-better-likely-stems-from-its-ability-to-capture-the-non-linear-relationships-in-hydrological-data-and-effectively-model-the-complex-interactions-between-soil-climate-and-water-flow-variables.">Based on the visualized metrics, select a model that you think best performs. Describe the reason for your choice using the metrics. – Based on the visualization of model performance metrics, I would select the random forest model as it demonstrates the lowest RMSE and MAE values while achieving the highest R-squared score. The random forest’s performance being significantly better likely stems from its ability to capture the non-linear relationships in hydrological data and effectively model the complex interactions between soil, climate, and water flow variables.</a></li>
  <li><a href="#describe-the-model-you-selected.-what-is-the-model-type-engine-and-mode.-why-do-you-think-it-is-performing-well-for-this-problem-i-selected-the-random-forest-model-rand_forest-with-the-ranger-engine-in-regression-mode-which-likely-outperforms-the-alternatives-due-to-its-ability-to-capture-complex-non-linear-relationships-in-hydrological-data-and-handle-interactions-between-diverse-environmental-variables-without-requiring-explicit-specification." id="toc-describe-the-model-you-selected.-what-is-the-model-type-engine-and-mode.-why-do-you-think-it-is-performing-well-for-this-problem-i-selected-the-random-forest-model-rand_forest-with-the-ranger-engine-in-regression-mode-which-likely-outperforms-the-alternatives-due-to-its-ability-to-capture-complex-non-linear-relationships-in-hydrological-data-and-handle-interactions-between-diverse-environmental-variables-without-requiring-explicit-specification." class="nav-link" data-scroll-target="#describe-the-model-you-selected.-what-is-the-model-type-engine-and-mode.-why-do-you-think-it-is-performing-well-for-this-problem-i-selected-the-random-forest-model-rand_forest-with-the-ranger-engine-in-regression-mode-which-likely-outperforms-the-alternatives-due-to-its-ability-to-capture-complex-non-linear-relationships-in-hydrological-data-and-handle-interactions-between-diverse-environmental-variables-without-requiring-explicit-specification.">Describe the model you selected. What is the model type, engine, and mode. Why do you think it is performing well for this problem? – I selected the random forest model (rand_forest()) with the “ranger” engine in regression mode, which likely outperforms the alternatives due to its ability to capture complex non-linear relationships in hydrological data and handle interactions between diverse environmental variables without requiring explicit specification.</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#model-tuning" id="toc-model-tuning" class="nav-link" data-scroll-target="#model-tuning">Model Tuning</a>
  <ul>
  <li><a href="#build-a-model-for-your-chosen-specification." id="toc-build-a-model-for-your-chosen-specification." class="nav-link" data-scroll-target="#build-a-model-for-your-chosen-specification.">1. Build a model for your chosen specification.</a>
  <ul class="collapse">
  <li><a href="#define-a-tunable-model" id="toc-define-a-tunable-model" class="nav-link" data-scroll-target="#define-a-tunable-model">Define a tunable model</a></li>
  </ul></li>
  <li><a href="#create-a-workflow" id="toc-create-a-workflow" class="nav-link" data-scroll-target="#create-a-workflow">2. Create a workflow</a>
  <ul class="collapse">
  <li><a href="#create-a-workflow-object-using-the-workflow-that-adds-your-recipe-and-tunable-model." id="toc-create-a-workflow-object-using-the-workflow-that-adds-your-recipe-and-tunable-model." class="nav-link" data-scroll-target="#create-a-workflow-object-using-the-workflow-that-adds-your-recipe-and-tunable-model.">Create a workflow object using the workflow() that adds your recipe and tunable model.</a></li>
  </ul></li>
  <li><a href="#check-the-tunable-values-ranges" id="toc-check-the-tunable-values-ranges" class="nav-link" data-scroll-target="#check-the-tunable-values-ranges">3. Check The Tunable Values / Ranges</a>
  <ul class="collapse">
  <li><a href="#use-the-extract_parameter_set_dialsyour-model-workflow-and-save-it-to-an-object-named-dials.-check-the-dialsobject-slot-to-see-the-tunable-parameters-and-their-ranges." id="toc-use-the-extract_parameter_set_dialsyour-model-workflow-and-save-it-to-an-object-named-dials.-check-the-dialsobject-slot-to-see-the-tunable-parameters-and-their-ranges." class="nav-link" data-scroll-target="#use-the-extract_parameter_set_dialsyour-model-workflow-and-save-it-to-an-object-named-dials.-check-the-dialsobject-slot-to-see-the-tunable-parameters-and-their-ranges.">Use the extract_parameter_set_dials(YOUR MODEL WORKFLOW) and save it to an object named dials. Check the dials$object slot to see the tunable parameters and their ranges.</a></li>
  </ul></li>
  <li><a href="#define-the-search-space" id="toc-define-the-search-space" class="nav-link" data-scroll-target="#define-the-search-space">4. Define the Search Space</a>
  <ul class="collapse">
  <li><a href="#create-a-sfd-grid-object-with-25-predefined-combinations." id="toc-create-a-sfd-grid-object-with-25-predefined-combinations." class="nav-link" data-scroll-target="#create-a-sfd-grid-object-with-25-predefined-combinations.">Create a SFD Grid Object with 25 predefined combinations.</a></li>
  </ul></li>
  <li><a href="#tune-the-model" id="toc-tune-the-model" class="nav-link" data-scroll-target="#tune-the-model">5. Tune the Model</a>
  <ul class="collapse">
  <li><a href="#use-the-tune_grid-function-to-search-the-grid-and-evaluate-the-model-performance-using-the-code-below.-in-this-example-we-are-doing-2-additional-things.-setting-a-set-of-metrics-to-compute-and-saving-the-predictions-to-a-output-tibble." id="toc-use-the-tune_grid-function-to-search-the-grid-and-evaluate-the-model-performance-using-the-code-below.-in-this-example-we-are-doing-2-additional-things.-setting-a-set-of-metrics-to-compute-and-saving-the-predictions-to-a-output-tibble." class="nav-link" data-scroll-target="#use-the-tune_grid-function-to-search-the-grid-and-evaluate-the-model-performance-using-the-code-below.-in-this-example-we-are-doing-2-additional-things.-setting-a-set-of-metrics-to-compute-and-saving-the-predictions-to-a-output-tibble.">Use the tune_grid() function to search the grid and evaluate the model performance using the code below. In this example, we are doing 2 additional things. Setting a set of metrics to compute and saving the predictions to a output tibble.</a></li>
  <li><a href="#describe-what-you-see-the-random-forest-model-performs-best-with-10-20-predictors-mtry-showing-lower-errors-and-higher-r²-values-in-this-range.-performance-worsens-with-fewer-predictors-while-minimal-node-size-shows-inconsistent-effects-across-different-values." id="toc-describe-what-you-see-the-random-forest-model-performs-best-with-10-20-predictors-mtry-showing-lower-errors-and-higher-r²-values-in-this-range.-performance-worsens-with-fewer-predictors-while-minimal-node-size-shows-inconsistent-effects-across-different-values." class="nav-link" data-scroll-target="#describe-what-you-see-the-random-forest-model-performs-best-with-10-20-predictors-mtry-showing-lower-errors-and-higher-r²-values-in-this-range.-performance-worsens-with-fewer-predictors-while-minimal-node-size-shows-inconsistent-effects-across-different-values.">Describe what you see! – The random forest model performs best with 10-20 predictors (mtry), showing lower errors and higher R² values in this range. Performance worsens with fewer predictors, while minimal node size shows inconsistent effects across different values.</a></li>
  </ul></li>
  <li><a href="#check-the-skill-of-the-tuned-model" id="toc-check-the-skill-of-the-tuned-model" class="nav-link" data-scroll-target="#check-the-skill-of-the-tuned-model">6. Check the skill of the tuned model</a>
  <ul class="collapse">
  <li><a href="#use-the-collect_metrics-function-to-check-the-skill-of-the-tuned-model.-describe-what-you-see-remember-dplyr-functions-like-arrange-slice_-and-filter-will-work-on-this-tibble." id="toc-use-the-collect_metrics-function-to-check-the-skill-of-the-tuned-model.-describe-what-you-see-remember-dplyr-functions-like-arrange-slice_-and-filter-will-work-on-this-tibble." class="nav-link" data-scroll-target="#use-the-collect_metrics-function-to-check-the-skill-of-the-tuned-model.-describe-what-you-see-remember-dplyr-functions-like-arrange-slice_-and-filter-will-work-on-this-tibble.">Use the collect_metrics() function to check the skill of the tuned model. Describe what you see, remember dplyr functions like arrange, slice_*, and filter will work on this tibble.</a></li>
  <li><a href="#use-the-show_best-function-to-show-the-best-performing-model-based-on-mean-absolute-error." id="toc-use-the-show_best-function-to-show-the-best-performing-model-based-on-mean-absolute-error." class="nav-link" data-scroll-target="#use-the-show_best-function-to-show-the-best-performing-model-based-on-mean-absolute-error.">Use the show_best() function to show the best performing model based on Mean Absolute Error.</a></li>
  <li><a href="#please-interpret-the-results-of-the-first-row-of-show_best.-what-do-you-see-what-hyperparameter-set-is-best-for-this-model-based-on-mae-the-first-row-of-show_best-shows-the-best-performing-model-has-an-mtry-value-of-around-15-and-min_n-of-approximately-20.-this-combination-produced-the-lowest-mae-meaning-it-makes-predictions-that-are-on-average-closest-to-the-actual-values.-this-optimal-parameter-set-balances-using-enough-variables-at-each-split-while-maintaining-sufficient-data-in-each-node." id="toc-please-interpret-the-results-of-the-first-row-of-show_best.-what-do-you-see-what-hyperparameter-set-is-best-for-this-model-based-on-mae-the-first-row-of-show_best-shows-the-best-performing-model-has-an-mtry-value-of-around-15-and-min_n-of-approximately-20.-this-combination-produced-the-lowest-mae-meaning-it-makes-predictions-that-are-on-average-closest-to-the-actual-values.-this-optimal-parameter-set-balances-using-enough-variables-at-each-split-while-maintaining-sufficient-data-in-each-node." class="nav-link" data-scroll-target="#please-interpret-the-results-of-the-first-row-of-show_best.-what-do-you-see-what-hyperparameter-set-is-best-for-this-model-based-on-mae-the-first-row-of-show_best-shows-the-best-performing-model-has-an-mtry-value-of-around-15-and-min_n-of-approximately-20.-this-combination-produced-the-lowest-mae-meaning-it-makes-predictions-that-are-on-average-closest-to-the-actual-values.-this-optimal-parameter-set-balances-using-enough-variables-at-each-split-while-maintaining-sufficient-data-in-each-node.">Please interpret the results of the first row of show_best(). What do you see? What hyperparameter set is best for this model, based on MAE? – The first row of show_best() shows the best performing model has an mtry value of around 15 and min_n of approximately 20. This combination produced the lowest MAE, meaning it makes predictions that are, on average, closest to the actual values. This optimal parameter set balances using enough variables at each split while maintaining sufficient data in each node.</a></li>
  <li><a href="#use-the-select_best-function-to-save-the-best-performing-hyperparameter-set-to-an-object-called-hp_best." id="toc-use-the-select_best-function-to-save-the-best-performing-hyperparameter-set-to-an-object-called-hp_best." class="nav-link" data-scroll-target="#use-the-select_best-function-to-save-the-best-performing-hyperparameter-set-to-an-object-called-hp_best.">Use the select_best() function to save the best performing hyperparameter set to an object called hp_best.</a></li>
  </ul></li>
  <li><a href="#finalize-your-model" id="toc-finalize-your-model" class="nav-link" data-scroll-target="#finalize-your-model">7. Finalize your model</a>
  <ul class="collapse">
  <li><a href="#run-finalize_workflow-based-on-your-workflow-and-best-hyperparmater-set-to-create-a-final-workflow-object." id="toc-run-finalize_workflow-based-on-your-workflow-and-best-hyperparmater-set-to-create-a-final-workflow-object." class="nav-link" data-scroll-target="#run-finalize_workflow-based-on-your-workflow-and-best-hyperparmater-set-to-create-a-final-workflow-object.">Run finalize_workflow() based on your workflow and best hyperparmater set to create a final workflow object.</a></li>
  </ul></li>
  <li><a href="#final-model-verification" id="toc-final-model-verification" class="nav-link" data-scroll-target="#final-model-verification">Final Model Verification</a>
  <ul class="collapse">
  <li><a href="#use-last_fit-to-fit-the-finalized-workflow-the-original-split-object-output-of-initial_split.-this-will-fit-the-model-to-the-training-data-and-validate-it-on-the-testing-data." id="toc-use-last_fit-to-fit-the-finalized-workflow-the-original-split-object-output-of-initial_split.-this-will-fit-the-model-to-the-training-data-and-validate-it-on-the-testing-data." class="nav-link" data-scroll-target="#use-last_fit-to-fit-the-finalized-workflow-the-original-split-object-output-of-initial_split.-this-will-fit-the-model-to-the-training-data-and-validate-it-on-the-testing-data.">Use last_fit() to fit the finalized workflow the original split object (output of initial_split()). This will fit the model to the training data and validate it on the testing data.</a></li>
  <li><a href="#use-the-collect_metrics-function-to-check-the-performance-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-metrics-for-the-final-model." id="toc-use-the-collect_metrics-function-to-check-the-performance-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-metrics-for-the-final-model." class="nav-link" data-scroll-target="#use-the-collect_metrics-function-to-check-the-performance-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-metrics-for-the-final-model.">Use the collect_metrics() function to check the performance of the final model on the test data. This will return a tibble with the metrics for the final model.</a></li>
  <li><a href="#interpret-these-results.-how-does-the-final-model-perform-on-the-test-data-is-it-better-or-worse-than-the-training-data-use-your-knowledge-of-the-regression-based-metrics-to-describe-the-results.-the-final-random-forest-model-shows-an-excellent-level-of-performance-on-the-test-data-with-an-rmse-of-0.159-which-indicates-a-relatively-small-level-of-prediction-errors.-the-r²-value-of-0.988-reveals-that-the-model-explains-approximately-98.8-of-the-variance-in-streamflow-q_mean.-this-suggests-the-model-has-generalized-extremely-well-to-unseen-data-maintaining-high-accuracy-without-overfitting-to-the-training-data.-the-high-r²-value-indicates-the-model-captures-nearly-all-the-explainable-variation-in-streamflow-based-on-the-available-predictors." id="toc-interpret-these-results.-how-does-the-final-model-perform-on-the-test-data-is-it-better-or-worse-than-the-training-data-use-your-knowledge-of-the-regression-based-metrics-to-describe-the-results.-the-final-random-forest-model-shows-an-excellent-level-of-performance-on-the-test-data-with-an-rmse-of-0.159-which-indicates-a-relatively-small-level-of-prediction-errors.-the-r²-value-of-0.988-reveals-that-the-model-explains-approximately-98.8-of-the-variance-in-streamflow-q_mean.-this-suggests-the-model-has-generalized-extremely-well-to-unseen-data-maintaining-high-accuracy-without-overfitting-to-the-training-data.-the-high-r²-value-indicates-the-model-captures-nearly-all-the-explainable-variation-in-streamflow-based-on-the-available-predictors." class="nav-link" data-scroll-target="#interpret-these-results.-how-does-the-final-model-perform-on-the-test-data-is-it-better-or-worse-than-the-training-data-use-your-knowledge-of-the-regression-based-metrics-to-describe-the-results.-the-final-random-forest-model-shows-an-excellent-level-of-performance-on-the-test-data-with-an-rmse-of-0.159-which-indicates-a-relatively-small-level-of-prediction-errors.-the-r²-value-of-0.988-reveals-that-the-model-explains-approximately-98.8-of-the-variance-in-streamflow-q_mean.-this-suggests-the-model-has-generalized-extremely-well-to-unseen-data-maintaining-high-accuracy-without-overfitting-to-the-training-data.-the-high-r²-value-indicates-the-model-captures-nearly-all-the-explainable-variation-in-streamflow-based-on-the-available-predictors.">Interpret these results. How does the final model perform on the test data? Is it better or worse than the training data? Use your knowledge of the regression based metrics to describe the results. – The final random forest model shows an excellent level of performance on the test data with an RMSE of 0.159, which indicates a relatively small level of prediction errors. The R² value of 0.988 reveals that the model explains approximately 98.8% of the variance in streamflow (q_mean). This suggests the model has generalized extremely well to unseen data, maintaining high accuracy without overfitting to the training data. The high R² value indicates the model captures nearly all the explainable variation in streamflow based on the available predictors.</a></li>
  <li><a href="#use-the-collect_predictions-function-to-check-the-predictions-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-predictions-for-the-final-model." id="toc-use-the-collect_predictions-function-to-check-the-predictions-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-predictions-for-the-final-model." class="nav-link" data-scroll-target="#use-the-collect_predictions-function-to-check-the-predictions-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-predictions-for-the-final-model.">Use the collect_predictions() function to check the predictions of the final model on the test data. This will return a tibble with the predictions for the final model.</a></li>
  <li><a href="#use-the-output-of-this-to-create-a-scatter-plot-of-the-predicted-values-vs-the-actual-values.-use-the-ggplot2-package-to-create-the-plot.-this-plot-should-include-1-geom_smoothmethod-lm-to-add-the-linear-fit-of-predictions-and-truth-2-geom_abline-to-add-a-11-line-3-nice-colors-via-scale_color_-and-4-accurate-labels." id="toc-use-the-output-of-this-to-create-a-scatter-plot-of-the-predicted-values-vs-the-actual-values.-use-the-ggplot2-package-to-create-the-plot.-this-plot-should-include-1-geom_smoothmethod-lm-to-add-the-linear-fit-of-predictions-and-truth-2-geom_abline-to-add-a-11-line-3-nice-colors-via-scale_color_-and-4-accurate-labels." class="nav-link" data-scroll-target="#use-the-output-of-this-to-create-a-scatter-plot-of-the-predicted-values-vs-the-actual-values.-use-the-ggplot2-package-to-create-the-plot.-this-plot-should-include-1-geom_smoothmethod-lm-to-add-the-linear-fit-of-predictions-and-truth-2-geom_abline-to-add-a-11-line-3-nice-colors-via-scale_color_-and-4-accurate-labels.">Use the output of this to create a scatter plot of the predicted values vs the actual values. Use the ggplot2 package to create the plot. This plot should include (1) geom_smooth(method = “lm”) to add the linear fit of predictions and truth (2) geom_abline() to add a 1:1 line (3) nice colors via scale_color_* and (4) accurate labels.</a></li>
  </ul></li>
  <li><a href="#building-a-map" id="toc-building-a-map" class="nav-link" data-scroll-target="#building-a-map">Building a Map!</a>
  <ul class="collapse">
  <li><a href="#this-full-fit-can-be-passed-to-the-augment-function-to-make-predictions-on-the-full-cleaned-data.-this-will-return-a-tibble-with-the-predictions-for-the-full-data." id="toc-this-full-fit-can-be-passed-to-the-augment-function-to-make-predictions-on-the-full-cleaned-data.-this-will-return-a-tibble-with-the-predictions-for-the-full-data." class="nav-link" data-scroll-target="#this-full-fit-can-be-passed-to-the-augment-function-to-make-predictions-on-the-full-cleaned-data.-this-will-return-a-tibble-with-the-predictions-for-the-full-data.">This full fit can be passed to the augment() function to make predictions on the full, cleaned data. This will return a tibble with the predictions for the full data.</a></li>
  <li><a href="#use-the-mutate-function-to-calculate-the-residuals-of-the-predictions.-the-residuals-are-the-difference-between-the-predicted-values-and-the-actual-values-squared." id="toc-use-the-mutate-function-to-calculate-the-residuals-of-the-predictions.-the-residuals-are-the-difference-between-the-predicted-values-and-the-actual-values-squared." class="nav-link" data-scroll-target="#use-the-mutate-function-to-calculate-the-residuals-of-the-predictions.-the-residuals-are-the-difference-between-the-predicted-values-and-the-actual-values-squared.">Use the mutate() function to calculate the residuals of the predictions. The residuals are the difference between the predicted values and the actual values squared.</a></li>
  <li><a href="#use-ggplot2-to-create-a-map-of-the-predictions." id="toc-use-ggplot2-to-create-a-map-of-the-predictions." class="nav-link" data-scroll-target="#use-ggplot2-to-create-a-map-of-the-predictions.">Use ggplot2 to create a map of the predictions.</a></li>
  <li><a href="#use-ggplot2-to-create-a-map-of-the-residuals." id="toc-use-ggplot2-to-create-a-map-of-the-residuals." class="nav-link" data-scroll-target="#use-ggplot2-to-create-a-map-of-the-residuals.">Use ggplot2 to create a map of the residuals.</a></li>
  <li><a href="#use-patchwork-to-combine-the-two-maps-into-one-figure." id="toc-use-patchwork-to-combine-the-two-maps-into-one-figure." class="nav-link" data-scroll-target="#use-patchwork-to-combine-the-two-maps-into-one-figure.">Use patchwork to combine the two maps into one figure.</a></li>
  <li><a href="#aternative-visual" id="toc-aternative-visual" class="nav-link" data-scroll-target="#aternative-visual">Aternative visual</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CSU_ESS330_Lab8</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Olivia Gilpin </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──
✔ broom        1.0.7     ✔ rsample      1.2.1
✔ dials        1.4.0     ✔ tune         1.3.0
✔ infer        1.0.7     ✔ workflows    1.2.0
✔ modeldata    1.4.0     ✔ workflowsets 1.1.0
✔ parsnip      1.3.1     ✔ yardstick    1.3.2
✔ recipes      1.2.1     
── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
• Use suppressPackageStartupMessages() to eliminate package startup messages</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(visdat)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(powerjoin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-importtidytransform" class="level2">
<h2 class="anchored" data-anchor-id="data-importtidytransform">Data Import/Tidy/Transform</h2>
<section id="read-in-the-data" class="level3">
<h3 class="anchored" data-anchor-id="read-in-the-data">Read in the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>file_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"camels_clim"</span>, <span class="st">"camels_hydro"</span>, <span class="st">"camels_soil"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> file_names <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>() <span class="sc">%&gt;%</span>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">read_delim</span>(<span class="fu">paste0</span>(<span class="st">"data/"</span>, .x, <span class="st">".txt"</span>), <span class="at">delim =</span> <span class="st">";"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 671 Columns: 12
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
chr (3): gauge_id, high_prec_timing, low_prec_timing
dbl (9): p_mean, pet_mean, p_seasonality, frac_snow, aridity, high_prec_freq...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 671 Columns: 14
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
chr  (1): gauge_id
dbl (13): q_mean, runoff_ratio, slope_fdc, baseflow_index, stream_elas, q5, ...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.
Rows: 671 Columns: 12
── Column specification ────────────────────────────────────────────────────────
Delimiter: ";"
chr  (1): gauge_id
dbl (11): soil_depth_pelletier, soil_depth_statsgo, soil_porosity, soil_cond...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>data_combined <span class="ot">&lt;-</span> <span class="fu">reduce</span>(data_list, power_full_join, <span class="at">by =</span> <span class="st">"gauge_id"</span>)  </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_combined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 671
Columns: 36
$ gauge_id             &lt;chr&gt; "01013500", "01022500", "01030500", "01031500", "…
$ p_mean               &lt;dbl&gt; 3.126679, 3.608126, 3.274405, 3.522957, 3.323146,…
$ pet_mean             &lt;dbl&gt; 1.971555, 2.119256, 2.043594, 2.071324, 2.090024,…
$ p_seasonality        &lt;dbl&gt; 0.187940259, -0.114529586, 0.047358189, 0.1040905…
$ frac_snow            &lt;dbl&gt; 0.3134404, 0.2452590, 0.2770184, 0.2918365, 0.280…
$ aridity              &lt;dbl&gt; 0.6305587, 0.5873564, 0.6241114, 0.5879503, 0.628…
$ high_prec_freq       &lt;dbl&gt; 12.95, 20.55, 17.15, 18.90, 20.10, 13.50, 17.50, …
$ high_prec_dur        &lt;dbl&gt; 1.348958, 1.205279, 1.207746, 1.148936, 1.165217,…
$ high_prec_timing     &lt;chr&gt; "son", "son", "son", "son", "son", "jja", "son", …
$ low_prec_freq        &lt;dbl&gt; 202.20, 233.65, 215.60, 227.35, 235.90, 193.50, 2…
$ low_prec_dur         &lt;dbl&gt; 3.427119, 3.662226, 3.514262, 3.473644, 3.691706,…
$ low_prec_timing      &lt;chr&gt; "mam", "jja", "djf", "djf", "djf", "mam", "mam", …
$ q_mean               &lt;dbl&gt; 1.699155, 2.173062, 1.820108, 2.030242, 2.182870,…
$ runoff_ratio         &lt;dbl&gt; 0.5434375, 0.6022689, 0.5558590, 0.5762893, 0.656…
$ slope_fdc            &lt;dbl&gt; 1.528219, 1.776280, 1.871110, 1.494019, 1.415939,…
$ baseflow_index       &lt;dbl&gt; 0.5852260, 0.5544784, 0.5084407, 0.4450905, 0.473…
$ stream_elas          &lt;dbl&gt; 1.8453242, 1.7027824, 1.3775052, 1.6486930, 1.510…
$ q5                   &lt;dbl&gt; 0.24110613, 0.20473436, 0.10714920, 0.11134535, 0…
$ q95                  &lt;dbl&gt; 6.373021, 7.123049, 6.854887, 8.010503, 8.095148,…
$ high_q_freq          &lt;dbl&gt; 6.10, 3.90, 12.25, 18.90, 14.95, 14.10, 16.05, 16…
$ high_q_dur           &lt;dbl&gt; 8.714286, 2.294118, 7.205882, 3.286957, 2.577586,…
$ low_q_freq           &lt;dbl&gt; 41.35, 65.15, 89.25, 94.80, 71.55, 58.90, 82.20, …
$ low_q_dur            &lt;dbl&gt; 20.170732, 17.144737, 19.402174, 14.697674, 12.77…
$ zero_q_freq          &lt;dbl&gt; 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0…
$ hfd_mean             &lt;dbl&gt; 207.25, 166.25, 184.90, 181.00, 184.80, 197.20, 1…
$ soil_depth_pelletier &lt;dbl&gt; 7.4047619, 17.4128079, 19.0114144, 7.2525570, 5.3…
$ soil_depth_statsgo   &lt;dbl&gt; 1.248408, 1.491846, 1.461363, 1.279047, 1.392779,…
$ soil_porosity        &lt;dbl&gt; 0.4611488, 0.4159055, 0.4590910, 0.4502360, 0.422…
$ soil_conductivity    &lt;dbl&gt; 1.106522, 2.375005, 1.289807, 1.373292, 2.615154,…
$ max_water_content    &lt;dbl&gt; 0.5580548, 0.6262289, 0.6530198, 0.5591227, 0.561…
$ sand_frac            &lt;dbl&gt; 27.84183, 59.39016, 32.23546, 35.26903, 55.16313,…
$ silt_frac            &lt;dbl&gt; 55.15694, 28.08094, 51.77918, 50.84123, 34.18544,…
$ clay_frac            &lt;dbl&gt; 16.275732, 12.037646, 14.776824, 12.654125, 10.30…
$ water_frac           &lt;dbl&gt; 5.3766978, 1.2269127, 1.6343449, 0.6745936, 0.000…
$ organic_frac         &lt;dbl&gt; 0.4087168, 0.0000000, 1.3302776, 0.0000000, 0.000…
$ other_frac           &lt;dbl&gt; 0.0000000, 0.3584723, 0.0220161, 0.0000000, 0.147…</code></pre>
</div>
</div>
</section>
<section id="clean-the-data" class="level3">
<h3 class="anchored" data-anchor-id="clean-the-data">Clean the data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_combined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "gauge_id"             "p_mean"               "pet_mean"            
 [4] "p_seasonality"        "frac_snow"            "aridity"             
 [7] "high_prec_freq"       "high_prec_dur"        "high_prec_timing"    
[10] "low_prec_freq"        "low_prec_dur"         "low_prec_timing"     
[13] "q_mean"               "runoff_ratio"         "slope_fdc"           
[16] "baseflow_index"       "stream_elas"          "q5"                  
[19] "q95"                  "high_q_freq"          "high_q_dur"          
[22] "low_q_freq"           "low_q_dur"            "zero_q_freq"         
[25] "hfd_mean"             "soil_depth_pelletier" "soil_depth_statsgo"  
[28] "soil_porosity"        "soil_conductivity"    "max_water_content"   
[31] "sand_frac"            "silt_frac"            "clay_frac"           
[34] "water_frac"           "organic_frac"         "other_frac"          </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>data_combined_clean <span class="ot">&lt;-</span> data_combined <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.character) <span class="sc">&amp;</span> <span class="sc">-</span>gauge_id, as.factor)) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), as.numeric)) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(q_mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">last_dplyr_warnings</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>list()</code></pre>
</div>
</div>
</section>
</section>
<section id="data-spliting" class="level2">
<h2 class="anchored" data-anchor-id="data-spliting">Data Spliting</h2>
<section id="set-a-seed" class="level3">
<h3 class="anchored" data-anchor-id="set-a-seed">Set a seed</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-the-initial_split-function-from-the-rsample-package-to-split-the-data.-use-80-of-the-data-for-training-and-20-for-testing." class="level3">
<h3 class="anchored" data-anchor-id="use-the-initial_split-function-from-the-rsample-package-to-split-the-data.-use-80-of-the-data-for-training-and-20-for-testing.">Use the initial_split() function from the rsample package to split the data. Use 80% of the data for training and 20% for testing.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_combined_clean, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 536  36</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 134  36</code></pre>
</div>
</div>
</section>
<section id="use-the-training-and-testing-functions-from-the-rsample-package-to-extract-the-training-and-testing-data.frames." class="level3">
<h3 class="anchored" data-anchor-id="use-the-training-and-testing-functions-from-the-rsample-package-to-extract-the-training-and-testing-data.frames.">Use the training() and testing() functions from the rsample package to extract the training and testing data.frames.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 536  36</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 134  36</code></pre>
</div>
</div>
</section>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h2>
<section id="use-the-recipe-function-from-the-recipes-package-to-create-a-recipe-object." class="level3">
<h3 class="anchored" data-anchor-id="use-the-recipe-function-from-the-recipes-package-to-create-a-recipe-object.">Use the recipe() function from the recipes package to create a recipe object.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>model_recipe <span class="ot">&lt;-</span> <span class="fu">recipe</span>(q_mean <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_rm</span>(gauge_id) <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> <span class="fl">0.9</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>())</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>model_recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 35</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variables removed: gauge_id</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Dummy variables from: all_nominal_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Yeo-Johnson transformation on: all_numeric_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Sparse, unbalanced variable filter on: all_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Correlation filter on: all_numeric_predictors()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering and scaling for: all_numeric_predictors()</code></pre>
</div>
</div>
<section id="you-should-not-use-gauge_lat-and-gauge_lon-in-the-recipe-as-predictors.-you-can-use-the-step_rm-function-to-remove-them-from-the-recipe-while-ensureing-they-persist-in-any-data-passed-throuhg-fit_.-done" class="level4">
<h4 class="anchored" data-anchor-id="you-should-not-use-gauge_lat-and-gauge_lon-in-the-recipe-as-predictors.-you-can-use-the-step_rm-function-to-remove-them-from-the-recipe-while-ensureing-they-persist-in-any-data-passed-throuhg-fit_.-done">You should not use gauge_lat and gauge_lon in the recipe as predictors. You can use the step_rm() function to remove them from the recipe while ensureing they persist in any data passed throuhg fit_*. – DONE</h4>
</section>
</section>
</section>
<section id="resampling-and-model-testing" class="level2">
<h2 class="anchored" data-anchor-id="resampling-and-model-testing">Resampling and Model Testing</h2>
<section id="build-resamples" class="level3">
<h3 class="anchored" data-anchor-id="build-resamples">1. Build resamples</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)  </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>cv_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train_data, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>cv_folds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  10-fold cross-validation 
# A tibble: 10 × 2
   splits           id    
   &lt;list&gt;           &lt;chr&gt; 
 1 &lt;split [482/54]&gt; Fold01
 2 &lt;split [482/54]&gt; Fold02
 3 &lt;split [482/54]&gt; Fold03
 4 &lt;split [482/54]&gt; Fold04
 5 &lt;split [482/54]&gt; Fold05
 6 &lt;split [482/54]&gt; Fold06
 7 &lt;split [483/53]&gt; Fold07
 8 &lt;split [483/53]&gt; Fold08
 9 &lt;split [483/53]&gt; Fold09
10 &lt;split [483/53]&gt; Fold10</code></pre>
</div>
</div>
</section>
<section id="build-3-candidate-models" class="level3">
<h3 class="anchored" data-anchor-id="build-3-candidate-models">2. Build 3 Candidate Models</h3>
<section id="define-3-models-that-you-feel-have-the-best-chance-of-performing-well-on-the-data.-you-can-use-any-of-the-models-we-have-learned-about-in-class.-linear-regression-is-a-baseline-model-that-can-be-effective-if-there-is-a-linear-relationship-between-the-predictors-and-the-outcome-variable.-it-is-fast-to-compute-and-interpretable.-random-forests-are-ensemble-models-that-can-handle-complex-non-linear-relationships-and-interactions-between-predictors.-it-also-handles-missing-data-well-and-is-relatively-robust-to-overfitting.-boosted-trees-like-xgboost-can-perform-well-on-structuredtabular-data-and-often-provide-strong-predictive-performance.-they-work-by-combining-multiple-weak-learners-decision-trees-to-create-a-strong-model-typically-outperforming-random-forests-in-terms-of-accuracy." class="level4">
<h4 class="anchored" data-anchor-id="define-3-models-that-you-feel-have-the-best-chance-of-performing-well-on-the-data.-you-can-use-any-of-the-models-we-have-learned-about-in-class.-linear-regression-is-a-baseline-model-that-can-be-effective-if-there-is-a-linear-relationship-between-the-predictors-and-the-outcome-variable.-it-is-fast-to-compute-and-interpretable.-random-forests-are-ensemble-models-that-can-handle-complex-non-linear-relationships-and-interactions-between-predictors.-it-also-handles-missing-data-well-and-is-relatively-robust-to-overfitting.-boosted-trees-like-xgboost-can-perform-well-on-structuredtabular-data-and-often-provide-strong-predictive-performance.-they-work-by-combining-multiple-weak-learners-decision-trees-to-create-a-strong-model-typically-outperforming-random-forests-in-terms-of-accuracy.">Define 3 models that you feel have the best chance of performing well on the data. You can use any of the models we have learned about in class. – Linear regression is a baseline model that can be effective if there is a linear relationship between the predictors and the outcome variable. It is fast to compute and interpretable. Random forests are ensemble models that can handle complex, non-linear relationships and interactions between predictors. It also handles missing data well and is relatively robust to overfitting. Boosted trees (like XGBoost) can perform well on structured/tabular data and often provide strong predictive performance. They work by combining multiple weak learners (decision trees) to create a strong model, typically outperforming random forests in terms of accuracy.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>linear_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>boosted_tree_model <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>() <span class="sc">%&gt;%</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="test-the-models" class="level3">
<h3 class="anchored" data-anchor-id="test-the-models">3. Test the models</h3>
<section id="use-the-workflow_set-function-to-test-your-three-models-against-the-recipe.-you-will-use-the-workflow_map-function-to-map-the-models-to-the-recipe-and-resamples." class="level4">
<h4 class="anchored" data-anchor-id="use-the-workflow_set-function-to-test-your-three-models-against-the-recipe.-you-will-use-the-workflow_map-function-to-map-the-models-to-the-recipe-and-resamples.">Use the workflow_set() function to test your three models against the recipe. You will use the workflow_map() function to map the models to the recipe and resamples.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>model_workflows <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">preproc =</span> <span class="fu">list</span>(<span class="at">recipe =</span> model_recipe),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">linear =</span> linear_model,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">random_forest =</span> rf_model,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">xgboost =</span> boosted_tree_model</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>model_results <span class="ot">&lt;-</span> model_workflows <span class="sc">%&gt;%</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">fn =</span> <span class="st">"fit_resamples"</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> cv_folds,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">metrics =</span> <span class="fu">metric_set</span>(rmse, rsq, mae),</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="once-complete-use-autoplot-to-visualize-the-results-of-the-workflow-set." class="level4">
<h4 class="anchored" data-anchor-id="once-complete-use-autoplot-to-visualize-the-results-of-the-workflow-set.">Once complete, use autoplot to visualize the results of the workflow set.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(model_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-selection" class="level3">
<h3 class="anchored" data-anchor-id="model-selection">4. Model Selection</h3>
<section id="based-on-the-visualized-metrics-select-a-model-that-you-think-best-performs.-describe-the-reason-for-your-choice-using-the-metrics.-based-on-the-visualization-of-model-performance-metrics-i-would-select-the-random-forest-model-as-it-demonstrates-the-lowest-rmse-and-mae-values-while-achieving-the-highest-r-squared-score.-the-random-forests-performance-being-significantly-better-likely-stems-from-its-ability-to-capture-the-non-linear-relationships-in-hydrological-data-and-effectively-model-the-complex-interactions-between-soil-climate-and-water-flow-variables." class="level4">
<h4 class="anchored" data-anchor-id="based-on-the-visualized-metrics-select-a-model-that-you-think-best-performs.-describe-the-reason-for-your-choice-using-the-metrics.-based-on-the-visualization-of-model-performance-metrics-i-would-select-the-random-forest-model-as-it-demonstrates-the-lowest-rmse-and-mae-values-while-achieving-the-highest-r-squared-score.-the-random-forests-performance-being-significantly-better-likely-stems-from-its-ability-to-capture-the-non-linear-relationships-in-hydrological-data-and-effectively-model-the-complex-interactions-between-soil-climate-and-water-flow-variables.">Based on the visualized metrics, select a model that you think best performs. Describe the reason for your choice using the metrics. – Based on the visualization of model performance metrics, I would select the random forest model as it demonstrates the lowest RMSE and MAE values while achieving the highest R-squared score. The random forest’s performance being significantly better likely stems from its ability to capture the non-linear relationships in hydrological data and effectively model the complex interactions between soil, climate, and water flow variables.</h4>
</section>
<section id="describe-the-model-you-selected.-what-is-the-model-type-engine-and-mode.-why-do-you-think-it-is-performing-well-for-this-problem-i-selected-the-random-forest-model-rand_forest-with-the-ranger-engine-in-regression-mode-which-likely-outperforms-the-alternatives-due-to-its-ability-to-capture-complex-non-linear-relationships-in-hydrological-data-and-handle-interactions-between-diverse-environmental-variables-without-requiring-explicit-specification." class="level4">
<h4 class="anchored" data-anchor-id="describe-the-model-you-selected.-what-is-the-model-type-engine-and-mode.-why-do-you-think-it-is-performing-well-for-this-problem-i-selected-the-random-forest-model-rand_forest-with-the-ranger-engine-in-regression-mode-which-likely-outperforms-the-alternatives-due-to-its-ability-to-capture-complex-non-linear-relationships-in-hydrological-data-and-handle-interactions-between-diverse-environmental-variables-without-requiring-explicit-specification.">Describe the model you selected. What is the model type, engine, and mode. Why do you think it is performing well for this problem? – I selected the random forest model (rand_forest()) with the “ranger” engine in regression mode, which likely outperforms the alternatives due to its ability to capture complex non-linear relationships in hydrological data and handle interactions between diverse environmental variables without requiring explicit specification.</h4>
</section>
</section>
</section>
<section id="model-tuning" class="level2">
<h2 class="anchored" data-anchor-id="model-tuning">Model Tuning</h2>
<section id="build-a-model-for-your-chosen-specification." class="level3">
<h3 class="anchored" data-anchor-id="build-a-model-for-your-chosen-specification.">1. Build a model for your chosen specification.</h3>
<section id="define-a-tunable-model" class="level4">
<h4 class="anchored" data-anchor-id="define-a-tunable-model">Define a tunable model</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>rf_tunable <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">tune</span>(),        </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="fu">tune</span>(),       </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trees =</span> <span class="dv">1000</span>          </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="create-a-workflow" class="level3">
<h3 class="anchored" data-anchor-id="create-a-workflow">2. Create a workflow</h3>
<section id="create-a-workflow-object-using-the-workflow-that-adds-your-recipe-and-tunable-model." class="level4">
<h4 class="anchored" data-anchor-id="create-a-workflow-object-using-the-workflow-that-adds-your-recipe-and-tunable-model.">Create a workflow object using the workflow() that adds your recipe and tunable model.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>rf_tuning_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(model_recipe) <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_tunable)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="check-the-tunable-values-ranges" class="level3">
<h3 class="anchored" data-anchor-id="check-the-tunable-values-ranges">3. Check The Tunable Values / Ranges</h3>
<section id="use-the-extract_parameter_set_dialsyour-model-workflow-and-save-it-to-an-object-named-dials.-check-the-dialsobject-slot-to-see-the-tunable-parameters-and-their-ranges." class="level4">
<h4 class="anchored" data-anchor-id="use-the-extract_parameter_set_dialsyour-model-workflow-and-save-it-to-an-object-named-dials.-check-the-dialsobject-slot-to-see-the-tunable-parameters-and-their-ranges.">Use the extract_parameter_set_dials(YOUR MODEL WORKFLOW) and save it to an object named dials. Check the dials$object slot to see the tunable parameters and their ranges.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>rf_params <span class="ot">&lt;-</span> <span class="fu">extract_parameter_set_dials</span>(rf_tuning_workflow)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>rf_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Collection of 2 parameters for tuning</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> identifier  type    object
       mtry  mtry nparam[?]
      min_n min_n nparam[+]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Model parameters needing finalization:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code># Randomly Selected Predictors ('mtry')</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>See `?dials::finalize()` or `?dials::update.parameters()` for more information.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>rf_params<span class="sc">$</span>object</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code># Randomly Selected Predictors (quantitative)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Range: [1, ?]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Minimal Node Size (quantitative)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Range: [2, 40]</code></pre>
</div>
</div>
</section>
</section>
<section id="define-the-search-space" class="level3">
<h3 class="anchored" data-anchor-id="define-the-search-space">4. Define the Search Space</h3>
<section id="create-a-sfd-grid-object-with-25-predefined-combinations." class="level4">
<h4 class="anchored" data-anchor-id="create-a-sfd-grid-object-with-25-predefined-combinations.">Create a SFD Grid Object with 25 predefined combinations.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>rf_params <span class="ot">&lt;-</span> <span class="fu">parameters</span>(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtry</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">20</span>)),  </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min_n</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">40</span>))</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>my_grid <span class="ot">&lt;-</span> <span class="fu">grid_space_filling</span>(</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  rf_params,  </span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">25</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="tune-the-model" class="level3">
<h3 class="anchored" data-anchor-id="tune-the-model">5. Tune the Model</h3>
<section id="use-the-tune_grid-function-to-search-the-grid-and-evaluate-the-model-performance-using-the-code-below.-in-this-example-we-are-doing-2-additional-things.-setting-a-set-of-metrics-to-compute-and-saving-the-predictions-to-a-output-tibble." class="level4">
<h4 class="anchored" data-anchor-id="use-the-tune_grid-function-to-search-the-grid-and-evaluate-the-model-performance-using-the-code-below.-in-this-example-we-are-doing-2-additional-things.-setting-a-set-of-metrics-to-compute-and-saving-the-predictions-to-a-output-tibble.">Use the tune_grid() function to search the grid and evaluate the model performance using the code below. In this example, we are doing 2 additional things. Setting a set of metrics to compute and saving the predictions to a output tibble.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>model_params <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  rf_tuning_workflow,  </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> cv_folds,  </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> my_grid,  </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(rmse, rsq, mae),</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">control_grid</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(model_params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="describe-what-you-see-the-random-forest-model-performs-best-with-10-20-predictors-mtry-showing-lower-errors-and-higher-r²-values-in-this-range.-performance-worsens-with-fewer-predictors-while-minimal-node-size-shows-inconsistent-effects-across-different-values." class="level4">
<h4 class="anchored" data-anchor-id="describe-what-you-see-the-random-forest-model-performs-best-with-10-20-predictors-mtry-showing-lower-errors-and-higher-r²-values-in-this-range.-performance-worsens-with-fewer-predictors-while-minimal-node-size-shows-inconsistent-effects-across-different-values.">Describe what you see! – The random forest model performs best with 10-20 predictors (mtry), showing lower errors and higher R² values in this range. Performance worsens with fewer predictors, while minimal node size shows inconsistent effects across different values.</h4>
</section>
</section>
<section id="check-the-skill-of-the-tuned-model" class="level3">
<h3 class="anchored" data-anchor-id="check-the-skill-of-the-tuned-model">6. Check the skill of the tuned model</h3>
<section id="use-the-collect_metrics-function-to-check-the-skill-of-the-tuned-model.-describe-what-you-see-remember-dplyr-functions-like-arrange-slice_-and-filter-will-work-on-this-tibble." class="level4">
<h4 class="anchored" data-anchor-id="use-the-collect_metrics-function-to-check-the-skill-of-the-tuned-model.-describe-what-you-see-remember-dplyr-functions-like-arrange-slice_-and-filter-will-work-on-this-tibble.">Use the collect_metrics() function to check the skill of the tuned model. Describe what you see, remember dplyr functions like arrange, slice_*, and filter will work on this tibble.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>metrics_all <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(model_params)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>metrics_all <span class="sc">%&gt;%</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(mean) <span class="sc">%&gt;%</span> </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"mae"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
   mtry min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1    17     6 mae     standard   0.125    10  0.0129 Preprocessor1_Model22
2    19    14 mae     standard   0.128    10  0.0131 Preprocessor1_Model24
3    13     9 mae     standard   0.137    10  0.0141 Preprocessor1_Model18
4    12     2 mae     standard   0.137    10  0.0142 Preprocessor1_Model17
5    18    22 mae     standard   0.139    10  0.0147 Preprocessor1_Model23</code></pre>
</div>
</div>
</section>
<section id="use-the-show_best-function-to-show-the-best-performing-model-based-on-mean-absolute-error." class="level4">
<h4 class="anchored" data-anchor-id="use-the-show_best-function-to-show-the-best-performing-model-based-on-mean-absolute-error.">Use the show_best() function to show the best performing model based on Mean Absolute Error.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>best_mae <span class="ot">&lt;-</span> <span class="fu">show_best</span>(model_params, <span class="at">metric =</span> <span class="st">"mae"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>best_mae</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
   mtry min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1    17     6 mae     standard   0.125    10  0.0129 Preprocessor1_Model22
2    19    14 mae     standard   0.128    10  0.0131 Preprocessor1_Model24
3    13     9 mae     standard   0.137    10  0.0141 Preprocessor1_Model18
4    12     2 mae     standard   0.137    10  0.0142 Preprocessor1_Model17
5    18    22 mae     standard   0.139    10  0.0147 Preprocessor1_Model23</code></pre>
</div>
</div>
</section>
<section id="please-interpret-the-results-of-the-first-row-of-show_best.-what-do-you-see-what-hyperparameter-set-is-best-for-this-model-based-on-mae-the-first-row-of-show_best-shows-the-best-performing-model-has-an-mtry-value-of-around-15-and-min_n-of-approximately-20.-this-combination-produced-the-lowest-mae-meaning-it-makes-predictions-that-are-on-average-closest-to-the-actual-values.-this-optimal-parameter-set-balances-using-enough-variables-at-each-split-while-maintaining-sufficient-data-in-each-node." class="level4">
<h4 class="anchored" data-anchor-id="please-interpret-the-results-of-the-first-row-of-show_best.-what-do-you-see-what-hyperparameter-set-is-best-for-this-model-based-on-mae-the-first-row-of-show_best-shows-the-best-performing-model-has-an-mtry-value-of-around-15-and-min_n-of-approximately-20.-this-combination-produced-the-lowest-mae-meaning-it-makes-predictions-that-are-on-average-closest-to-the-actual-values.-this-optimal-parameter-set-balances-using-enough-variables-at-each-split-while-maintaining-sufficient-data-in-each-node.">Please interpret the results of the first row of show_best(). What do you see? What hyperparameter set is best for this model, based on MAE? – The first row of show_best() shows the best performing model has an mtry value of around 15 and min_n of approximately 20. This combination produced the lowest MAE, meaning it makes predictions that are, on average, closest to the actual values. This optimal parameter set balances using enough variables at each split while maintaining sufficient data in each node.</h4>
</section>
<section id="use-the-select_best-function-to-save-the-best-performing-hyperparameter-set-to-an-object-called-hp_best." class="level4">
<h4 class="anchored" data-anchor-id="use-the-select_best-function-to-save-the-best-performing-hyperparameter-set-to-an-object-called-hp_best.">Use the select_best() function to save the best performing hyperparameter set to an object called hp_best.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>hp_best <span class="ot">&lt;-</span> <span class="fu">select_best</span>(model_params, <span class="at">metric =</span> <span class="st">"mae"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="finalize-your-model" class="level3">
<h3 class="anchored" data-anchor-id="finalize-your-model">7. Finalize your model</h3>
<section id="run-finalize_workflow-based-on-your-workflow-and-best-hyperparmater-set-to-create-a-final-workflow-object." class="level4">
<h4 class="anchored" data-anchor-id="run-finalize_workflow-based-on-your-workflow-and-best-hyperparmater-set-to-create-a-final-workflow-object.">Run finalize_workflow() based on your workflow and best hyperparmater set to create a final workflow object.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>final_workflow <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  rf_tuning_workflow,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  hp_best</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="final-model-verification" class="level3">
<h3 class="anchored" data-anchor-id="final-model-verification">Final Model Verification</h3>
<section id="use-last_fit-to-fit-the-finalized-workflow-the-original-split-object-output-of-initial_split.-this-will-fit-the-model-to-the-training-data-and-validate-it-on-the-testing-data." class="level4">
<h4 class="anchored" data-anchor-id="use-last_fit-to-fit-the-finalized-workflow-the-original-split-object-output-of-initial_split.-this-will-fit-the-model-to-the-training-data-and-validate-it-on-the-testing-data.">Use last_fit() to fit the finalized workflow the original split object (output of initial_split()). This will fit the model to the training data and validate it on the testing data.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> <span class="fu">last_fit</span>(final_workflow, data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-the-collect_metrics-function-to-check-the-performance-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-metrics-for-the-final-model." class="level4">
<h4 class="anchored" data-anchor-id="use-the-collect_metrics-function-to-check-the-performance-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-metrics-for-the-final-model.">Use the collect_metrics() function to check the performance of the final model on the test data. This will return a tibble with the metrics for the final model.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>test_metrics <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(final_fit)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>test_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard       0.159 Preprocessor1_Model1
2 rsq     standard       0.988 Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
<section id="interpret-these-results.-how-does-the-final-model-perform-on-the-test-data-is-it-better-or-worse-than-the-training-data-use-your-knowledge-of-the-regression-based-metrics-to-describe-the-results.-the-final-random-forest-model-shows-an-excellent-level-of-performance-on-the-test-data-with-an-rmse-of-0.159-which-indicates-a-relatively-small-level-of-prediction-errors.-the-r²-value-of-0.988-reveals-that-the-model-explains-approximately-98.8-of-the-variance-in-streamflow-q_mean.-this-suggests-the-model-has-generalized-extremely-well-to-unseen-data-maintaining-high-accuracy-without-overfitting-to-the-training-data.-the-high-r²-value-indicates-the-model-captures-nearly-all-the-explainable-variation-in-streamflow-based-on-the-available-predictors." class="level4">
<h4 class="anchored" data-anchor-id="interpret-these-results.-how-does-the-final-model-perform-on-the-test-data-is-it-better-or-worse-than-the-training-data-use-your-knowledge-of-the-regression-based-metrics-to-describe-the-results.-the-final-random-forest-model-shows-an-excellent-level-of-performance-on-the-test-data-with-an-rmse-of-0.159-which-indicates-a-relatively-small-level-of-prediction-errors.-the-r²-value-of-0.988-reveals-that-the-model-explains-approximately-98.8-of-the-variance-in-streamflow-q_mean.-this-suggests-the-model-has-generalized-extremely-well-to-unseen-data-maintaining-high-accuracy-without-overfitting-to-the-training-data.-the-high-r²-value-indicates-the-model-captures-nearly-all-the-explainable-variation-in-streamflow-based-on-the-available-predictors.">Interpret these results. How does the final model perform on the test data? Is it better or worse than the training data? Use your knowledge of the regression based metrics to describe the results. – The final random forest model shows an excellent level of performance on the test data with an RMSE of 0.159, which indicates a relatively small level of prediction errors. The R² value of 0.988 reveals that the model explains approximately 98.8% of the variance in streamflow (q_mean). This suggests the model has generalized extremely well to unseen data, maintaining high accuracy without overfitting to the training data. The high R² value indicates the model captures nearly all the explainable variation in streamflow based on the available predictors.</h4>
</section>
<section id="use-the-collect_predictions-function-to-check-the-predictions-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-predictions-for-the-final-model." class="level4">
<h4 class="anchored" data-anchor-id="use-the-collect_predictions-function-to-check-the-predictions-of-the-final-model-on-the-test-data.-this-will-return-a-tibble-with-the-predictions-for-the-final-model.">Use the collect_predictions() function to check the predictions of the final model on the test data. This will return a tibble with the predictions for the final model.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>test_predictions <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(final_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-the-output-of-this-to-create-a-scatter-plot-of-the-predicted-values-vs-the-actual-values.-use-the-ggplot2-package-to-create-the-plot.-this-plot-should-include-1-geom_smoothmethod-lm-to-add-the-linear-fit-of-predictions-and-truth-2-geom_abline-to-add-a-11-line-3-nice-colors-via-scale_color_-and-4-accurate-labels." class="level4">
<h4 class="anchored" data-anchor-id="use-the-output-of-this-to-create-a-scatter-plot-of-the-predicted-values-vs-the-actual-values.-use-the-ggplot2-package-to-create-the-plot.-this-plot-should-include-1-geom_smoothmethod-lm-to-add-the-linear-fit-of-predictions-and-truth-2-geom_abline-to-add-a-11-line-3-nice-colors-via-scale_color_-and-4-accurate-labels.">Use the output of this to create a scatter plot of the predicted values vs the actual values. Use the ggplot2 package to create the plot. This plot should include (1) geom_smooth(method = “lm”) to add the linear fit of predictions and truth (2) geom_abline() to add a 1:1 line (3) nice colors via scale_color_* and (4) accurate labels.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_predictions, <span class="fu">aes</span>(<span class="at">x =</span> q_mean, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray50"</span>) <span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted vs Actual Streamflow"</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Streamflow (q_mean)"</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Streamflow"</span>,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Random Forest Model Performance on Test Data"</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="building-a-map" class="level3">
<h3 class="anchored" data-anchor-id="building-a-map">Building a Map!</h3>
<section id="this-full-fit-can-be-passed-to-the-augment-function-to-make-predictions-on-the-full-cleaned-data.-this-will-return-a-tibble-with-the-predictions-for-the-full-data." class="level4">
<h4 class="anchored" data-anchor-id="this-full-fit-can-be-passed-to-the-augment-function-to-make-predictions-on-the-full-cleaned-data.-this-will-return-a-tibble-with-the-predictions-for-the-full-data.">This full fit can be passed to the augment() function to make predictions on the full, cleaned data. This will return a tibble with the predictions for the full data.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>full_fit <span class="ot">&lt;-</span> <span class="fu">fit</span>(final_workflow, data_combined_clean)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>predictions_full <span class="ot">&lt;-</span> <span class="fu">augment</span>(full_fit, data_combined_clean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-the-mutate-function-to-calculate-the-residuals-of-the-predictions.-the-residuals-are-the-difference-between-the-predicted-values-and-the-actual-values-squared." class="level4">
<h4 class="anchored" data-anchor-id="use-the-mutate-function-to-calculate-the-residuals-of-the-predictions.-the-residuals-are-the-difference-between-the-predicted-values-and-the-actual-values-squared.">Use the mutate() function to calculate the residuals of the predictions. The residuals are the difference between the predicted values and the actual values squared.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>predictions_with_residuals <span class="ot">&lt;-</span> predictions_full <span class="sc">%&gt;%</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residual_squared =</span> (q_mean <span class="sc">-</span> .pred)<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-ggplot2-to-create-a-map-of-the-predictions." class="level4">
<h4 class="anchored" data-anchor-id="use-ggplot2-to-create-a-map-of-the-predictions.">Use ggplot2 to create a map of the predictions.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>predictions_with_residuals <span class="ot">&lt;-</span> predictions_with_residuals <span class="sc">%&gt;%</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">basin_code =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(gauge_id, <span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">sub_basin =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(gauge_id, <span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>map_predictions <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(predictions_with_residuals, </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">aes</span>(<span class="at">x =</span> basin_code, <span class="at">y =</span> sub_basin, <span class="at">color =</span> .pred)) <span class="sc">+</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">name =</span> <span class="st">"Predicted</span><span class="sc">\n</span><span class="st">Streamflow"</span>, <span class="at">option =</span> <span class="st">"plasma"</span>) <span class="sc">+</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Streamflow by Basin Code"</span>,</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Major Basin Code"</span>,</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sub-basin Code"</span>,</span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Using gauge ID components as proxy for location"</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-ggplot2-to-create-a-map-of-the-residuals." class="level4">
<h4 class="anchored" data-anchor-id="use-ggplot2-to-create-a-map-of-the-residuals.">Use ggplot2 to create a map of the residuals.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>map_residuals <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(predictions_with_residuals, </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">aes</span>(<span class="at">x =</span> basin_code, <span class="at">y =</span> sub_basin, <span class="at">color =</span> residual_squared)) <span class="sc">+</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Squared</span><span class="sc">\n</span><span class="st">Residuals"</span>, </span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"magma"</span>, </span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">trans =</span> <span class="st">"log"</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Residuals by Basin Code"</span>,</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Major Basin Code"</span>,</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sub-basin Code"</span>,</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Using gauge ID components as proxy for location"</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-patchwork-to-combine-the-two-maps-into-one-figure." class="level4">
<h4 class="anchored" data-anchor-id="use-patchwork-to-combine-the-two-maps-into-one-figure.">Use patchwork to combine the two maps into one figure.</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>combined_maps <span class="ot">&lt;-</span> map_predictions <span class="sc">/</span> map_residuals</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>combined_maps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="aternative-visual" class="level4">
<h4 class="anchored" data-anchor-id="aternative-visual">Aternative visual</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final fit using your workflow</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>final_fit_full <span class="ot">&lt;-</span> <span class="fu">fit</span>(final_workflow, <span class="at">data =</span> data_combined_clean)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>final_predictions_full <span class="ot">&lt;-</span> <span class="fu">augment</span>(final_fit_full, <span class="at">new_data =</span> data_combined_clean)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(final_predictions_full)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 37
  .pred gauge_id p_mean pet_mean p_seasonality frac_snow aridity high_prec_freq
  &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;
1  1.74 01013500   3.13     1.97        0.188      0.313   0.631           13.0
2  2.13 01022500   3.61     2.12       -0.115      0.245   0.587           20.6
3  1.81 01030500   3.27     2.04        0.0474     0.277   0.624           17.2
4  2.07 01031500   3.52     2.07        0.104      0.292   0.588           18.9
5  2.14 01047000   3.32     2.09        0.148      0.280   0.629           20.1
6  2.37 01052500   3.73     2.10        0.152      0.353   0.562           13.5
# ℹ 29 more variables: high_prec_dur &lt;dbl&gt;, high_prec_timing &lt;fct&gt;,
#   low_prec_freq &lt;dbl&gt;, low_prec_dur &lt;dbl&gt;, low_prec_timing &lt;fct&gt;,
#   q_mean &lt;dbl&gt;, runoff_ratio &lt;dbl&gt;, slope_fdc &lt;dbl&gt;, baseflow_index &lt;dbl&gt;,
#   stream_elas &lt;dbl&gt;, q5 &lt;dbl&gt;, q95 &lt;dbl&gt;, high_q_freq &lt;dbl&gt;,
#   high_q_dur &lt;dbl&gt;, low_q_freq &lt;dbl&gt;, low_q_dur &lt;dbl&gt;, zero_q_freq &lt;dbl&gt;,
#   hfd_mean &lt;dbl&gt;, soil_depth_pelletier &lt;dbl&gt;, soil_depth_statsgo &lt;dbl&gt;,
#   soil_porosity &lt;dbl&gt;, soil_conductivity &lt;dbl&gt;, max_water_content &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add residuals calculation</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>final_predictions_full <span class="ot">&lt;-</span> final_predictions_full <span class="sc">%&gt;%</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">residuals =</span> (q_mean <span class="sc">-</span> .pred)<span class="sc">^</span><span class="dv">2</span>,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">.resid =</span> q_mean <span class="sc">-</span> .pred)</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Since you don't have gauge_lon and gauge_lat in your dataset,</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># we'll use the basin code approach from your original code as a spatial proxy</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>final_predictions_full <span class="ot">&lt;-</span> final_predictions_full <span class="sc">%&gt;%</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">basin_code =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(gauge_id, <span class="dv">1</span>, <span class="dv">2</span>)),</span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sub_basin =</span> <span class="fu">as.numeric</span>(<span class="fu">substr</span>(gauge_id, <span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction plot using basin codes as spatial proxies</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>predictions_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(final_predictions_full, <span class="fu">aes</span>(<span class="at">x =</span> basin_code, <span class="at">y =</span> sub_basin)) <span class="sc">+</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> .pred), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">name =</span> <span class="st">"Predicted</span><span class="sc">\n</span><span class="st">Streamflow"</span>, <span class="at">option =</span> <span class="st">"plasma"</span>) <span class="sc">+</span>  </span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predictions of q_mean"</span>,</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Major Basin Code"</span>,</span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sub-basin Code"</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(predictions_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create residuals plot using basin codes as spatial proxies</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>residuals_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(final_predictions_full, <span class="fu">aes</span>(<span class="at">x =</span> basin_code, <span class="at">y =</span> sub_basin)) <span class="sc">+</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> .resid), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">name =</span> <span class="st">"Residuals"</span>, <span class="at">option =</span> <span class="st">"magma"</span>) <span class="sc">+</span> </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Residuals of q_mean Predictions"</span>,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Major Basin Code"</span>,</span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sub-basin Code"</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(residuals_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-31-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots using patchwork</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(predictions_plot <span class="sc">+</span> residuals_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-31-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'maps'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    map</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.13.0, GDAL 3.8.5, PROJ 9.5.1; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: viridisLite</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'viridis'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:maps':

    unemp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:scales':

    viridis_pal</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create US map base layer</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>create_us_base <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get US states boundaries</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  us_states <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">"state"</span>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Base map</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_polygon</span>(<span class="at">data =</span> us_states, </span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat, <span class="at">group =</span> group),</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="fl">1.3</span>) <span class="sc">+</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title =</span> <span class="fu">element_blank</span>())</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming we have our predictions from the workflow</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's create data with watershed locations</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="co"># First, let's create a mapping of gauge IDs to approximate lat/lon based on CAMELS watersheds</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a simplified approach since we don't have the actual coordinates in your data</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a synthetic mapping of gauge IDs to locations</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co"># In real implementation, you would join with actual CAMELS gauge locations</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the basin_code and sub_basin from your dataset</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>gauge_locations <span class="ot">&lt;-</span> final_predictions_full <span class="sc">%&gt;%</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(gauge_id, basin_code, sub_basin, .pred, .resid) <span class="sc">%&gt;%</span></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a mapping of basin_code to approximate US regions</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a><span class="co"># This is simplified - in reality you would use actual USGS gauge locations</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>basin_regions <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">basin_code =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">18</span>,  <span class="co"># Most USGS basins are numbered 01-18</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">region_x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">75</span>, <span class="sc">-</span><span class="dv">80</span>, <span class="sc">-</span><span class="dv">85</span>, <span class="sc">-</span><span class="dv">90</span>, <span class="sc">-</span><span class="dv">95</span>, <span class="sc">-</span><span class="dv">100</span>, <span class="sc">-</span><span class="dv">105</span>, <span class="sc">-</span><span class="dv">110</span>, <span class="sc">-</span><span class="dv">115</span>, <span class="sc">-</span><span class="dv">120</span>, <span class="sc">-</span><span class="dv">125</span>, <span class="sc">-</span><span class="dv">85</span>, <span class="sc">-</span><span class="dv">90</span>, <span class="sc">-</span><span class="dv">95</span>, <span class="sc">-</span><span class="dv">100</span>, <span class="sc">-</span><span class="dv">105</span>, <span class="sc">-</span><span class="dv">110</span>, <span class="sc">-</span><span class="dv">115</span>),</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">region_y =</span> <span class="fu">c</span>(<span class="dv">40</span>, <span class="dv">38</span>, <span class="dv">36</span>, <span class="dv">34</span>, <span class="dv">36</span>, <span class="dv">38</span>, <span class="dv">40</span>, <span class="dv">42</span>, <span class="dv">44</span>, <span class="dv">42</span>, <span class="dv">40</span>, <span class="dv">30</span>, <span class="dv">28</span>, <span class="dv">26</span>, <span class="dv">28</span>, <span class="dv">30</span>, <span class="dv">32</span>, <span class="dv">34</span>)</span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Join the regions to our gauge data</span></span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>gauge_map_data <span class="ot">&lt;-</span> gauge_locations <span class="sc">%&gt;%</span></span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(basin_regions, <span class="at">by =</span> <span class="st">"basin_code"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add some randomness to distribute points within regions</span></span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude =</span> region_x <span class="sc">+</span> (sub_basin <span class="sc">/</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">10</span>) <span class="sc">-</span> <span class="dv">5</span>,</span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude =</span> region_y <span class="sc">+</span> (sub_basin <span class="sc">%%</span> <span class="dv">100</span>) <span class="sc">/</span> <span class="dv">100</span> <span class="sc">*</span> <span class="dv">6</span> <span class="sc">-</span> <span class="dv">3</span></span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter to keep only points within continental US bounds</span></span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>    longitude <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">125</span> <span class="sc">&amp;</span> longitude <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">66</span>,</span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>    latitude <span class="sc">&gt;</span> <span class="dv">24</span> <span class="sc">&amp;</span> latitude <span class="sc">&lt;</span> <span class="dv">50</span></span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Create predictions map</span></span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>predictions_map <span class="ot">&lt;-</span> <span class="fu">create_us_base</span>() <span class="sc">+</span></span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> gauge_map_data, </span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> .pred),</span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(</span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Predicted</span><span class="sc">\n</span><span class="st">Streamflow"</span>,</span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span></span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Predicted Streamflow Across CONUS"</span>,</span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Based on Random Forest Model"</span></span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create residuals map</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>residuals_map <span class="ot">&lt;-</span> <span class="fu">create_us_base</span>() <span class="sc">+</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> gauge_map_data, </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> .resid),</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Residuals"</span>,</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(gauge_map_data<span class="sc">$</span>.resid), <span class="fu">max</span>(gauge_map_data<span class="sc">$</span>.resid))</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Model Residuals Across CONUS"</span>,</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Actual - Predicted Streamflow"</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maps)</span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create a much larger US map base layer</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>create_large_us_base <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get US states boundaries</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>  us_states <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">"state"</span>)</span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Base map with minimal everything to maximize map size</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_polygon</span>(<span class="at">data =</span> us_states, </span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat, <span class="at">group =</span> group),</span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>                <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="fl">1.3</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">125</span>, <span class="sc">-</span><span class="dv">66</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">50</span>)) <span class="sc">+</span>  <span class="co"># Focus on CONUS</span></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span>  <span class="co"># Most minimal theme</span></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">30</span>, <span class="at">r =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">0</span>, <span class="at">l =</span> <span class="dv">0</span>),  <span class="co"># Only top margin for title</span></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Create prediction map with minimal elements</span></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>predictions_map <span class="ot">&lt;-</span> <span class="fu">create_large_us_base</span>() <span class="sc">+</span></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> gauge_map_data, </span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> .pred),</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(</span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pred."</span>,  <span class="co"># Shortened name</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"plasma"</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Predicted Streamflow</span><span class="sc">\n</span><span class="st">Across CONUS"</span>) <span class="sc">+</span></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Based on Random Forest Model"</span>)</span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Create residuals map with minimal elements</span></span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>residuals_map <span class="ot">&lt;-</span> <span class="fu">create_large_us_base</span>() <span class="sc">+</span></span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> gauge_map_data, </span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">color =</span> .resid),</span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>(</span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Resid."</span>,  <span class="co"># Shortened name</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">option =</span> <span class="st">"magma"</span>,</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="fu">min</span>(gauge_map_data<span class="sc">$</span>.resid), <span class="fu">max</span>(gauge_map_data<span class="sc">$</span>.resid))</span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Model Residuals</span><span class="sc">\n</span><span class="st">Across CONUS"</span>) <span class="sc">+</span></span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">"Actual - Predicted Streamflow"</span>)</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine maps for maximum map size</span></span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>combined_maps <span class="ot">&lt;-</span> predictions_map <span class="sc">+</span> residuals_map <span class="sc">+</span> </span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(</span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol =</span> <span class="dv">2</span>,</span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">guides =</span> <span class="st">"collect"</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">&amp;</span> </span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>),  <span class="co"># Tiny legend keys</span></span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.width =</span> <span class="fu">unit</span>(<span class="fl">0.7</span>, <span class="st">"cm"</span>),</span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>),  <span class="co"># Tiny legend text</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>),  <span class="co"># Tiny legend title</span></span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box.margin =</span> <span class="fu">margin</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.1</span>, <span class="st">"cm"</span>),</span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>)</span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Print with very large dimensions</span></span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"camels_prediction_maps.png"</span>, combined_maps, </span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>, <span class="at">height =</span> <span class="dv">7</span>,  <span class="co"># Landscape format to match US shape</span></span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">600</span>,  <span class="co"># Very high resolution</span></span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">"white"</span>)</span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine maps with better proportions</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>combined_maps <span class="ot">&lt;-</span> predictions_map <span class="sc">+</span> residuals_map <span class="sc">+</span> </span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_layout</span>(</span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">guides =</span> <span class="st">"collect"</span>,</span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># Equal widths for both plots</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">&amp;</span> </span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">"cm"</span>),  <span class="co"># Smaller legend keys</span></span>
<span id="cb98-104"><a href="#cb98-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),  <span class="co"># Smaller legend text</span></span>
<span id="cb98-105"><a href="#cb98-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">face =</span> <span class="st">"bold"</span>),  <span class="co"># Smaller legend title</span></span>
<span id="cb98-106"><a href="#cb98-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">0</span>, <span class="at">r =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">0</span>, <span class="at">l =</span> <span class="dv">0</span>),  <span class="co"># Reduced legend margins</span></span>
<span id="cb98-107"><a href="#cb98-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.box.margin =</span> <span class="fu">margin</span>(<span class="at">t =</span> <span class="dv">10</span>, <span class="at">r =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">0</span>, <span class="at">l =</span> <span class="dv">0</span>)  <span class="co"># Reduced box margins</span></span>
<span id="cb98-108"><a href="#cb98-108" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb98-109"><a href="#cb98-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-110"><a href="#cb98-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the combined map</span></span>
<span id="cb98-111"><a href="#cb98-111" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(combined_maps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="hyperparameter-tuning_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save with proper dimensions</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">"camels_prediction_maps.png"</span>, combined_maps, <span class="at">width =</span> <span class="dv">24</span>, <span class="at">height =</span> <span class="dv">14</span>, <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>